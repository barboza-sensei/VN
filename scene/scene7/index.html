<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Escena 7 — El Libro Rasgado</title>
  <link rel="stylesheet" href="../../style.css" />
  <style>
    /* Estilos omitidos por brevedad, asumiendo que están correctos */
  </style>
</head>

<body>
  <div class="dialogue-box" id="main-dialogue-box">
    <p id="text"></p>
    
    <div id="choices"></div>
    <button id="nextBtn" title="Continuar">➤</button> 
  </div>

  <script>
    let score = parseInt(localStorage.getItem('score') || 0);

    const IMG_GENERAL = 'assets/bg/banca_oscura.png';
    const IMG_DESAFIO = 'assets/bg/cuaderno_ecuacion.png';

    function formatText(content) {
        return content.replace(/\*\*(.*?)\*\*/g, '<span class="resaltado">$1</span>');
    }
    
    function changeBackground(imageUrl) {
        document.body.style.backgroundImage = `url('${imageUrl}')`;
    }

    // --- DATA DE LA ESCENA 7 (Desafío de Detección de Error - CON DISTRIBUCIÓN) ---
    const scene7 = {
      id: 7,
      title: "El Libro Rasgado",
      text: [
        { type: 'narrative', content: "El tren te deja en una pequeña estación abandonada, dentro de un túnel. La luz es tenue y gotea humedad."},
        { type: 'narrative', content: "Encontrás un cuaderno abierto sobre una banca. Una ecuación está escrita con una pequeña trampa."}, 
        { type: 'voice', speaker: 'Disparia', content: "¡Mira esa solución! ¿Por qué esforzarse tanto si podés saltarte un paso? Nadie lo notará..."}, 
        { type: 'voice', speaker: 'Equalis', content: "La verdad es indivisible. Un error, por pequeño que sea, contamina todo el proceso. **Encuentra la falla**."}, 
        { type: 'challenge', 
          // Secuencia con error: 2(x+3) = 10 -> 2x + 3 = 10 (ERROR: No distribuyó el 2 al 3)
          question: "El papel tiembla. Algo no encaja en la siguiente secuencia lógica. ¿Dónde está el error?\n\n2(x+3) = 10\n2x + 3 = 10\n2x = 7\nx = 3.5", 
          answer: "El error está en el segundo paso: 2(x+3) es 2x + 6, no 2x + 3.",
          success: "Equalis: La verdad matemática ha sido restaurada. La propiedad distributiva es fundamental. (+1 Lógica).", 
          failure: "Disparia: ¡Un suspiro! Esos pequeños errores son los que hacen la vida interesante. El Caos agradece la confusión. (-1 Lógica).", 
          transitionSuccess: { text: "El cuaderno se recompone, las páginas se vuelven a unir y el camino hacia la salida se ilumina.", nextScene: "../scene8/index.html" },
          transitionFail: { text: "El papel se deshace en tus manos, dejando solo polvo. Buscás a tientas la próxima puerta.", nextScene: "../scene8/index.html" }, 
          choices: [
              { text: "El error está en el primer paso: la igualdad no se cumple.", isCorrect: false },
              { text: "El error está en el segundo paso: 2(x+3) es 2x + 6, no 2x + 3.", isCorrect: true },
              { text: "El error está en el último paso: la división de 7/2 es 4, no 3.5.", isCorrect: false }
          ]
        }
      ]
    };

    const textEl = document.getElementById("text");
    const choicesEl = document.getElementById("choices");
    const nextBtn = document.getElementById("nextBtn");
    
    let currentLine = 0; 
    const sceneData = scene7.text; 

    function showLine() {
      if (currentLine >= sceneData.length) return;

      if (currentLine === 1) { 
        changeBackground(IMG_GENERAL);
      } else if (currentLine === 3) { 
        changeBackground(IMG_DESAFIO);
      }
      
      const lineData = sceneData[currentLine];
      textEl.className = 'fade-text'; 

      if (lineData.type === 'challenge') {
          renderChallenge(lineData);
          nextBtn.style.display = 'none'; 
          return; 
      }
      
      let content = formatText(lineData.content);
      let speaker = lineData.speaker;
      
      if (speaker) {
          let voiceClass;
          if (speaker.toLowerCase() === 'equalis') {
              voiceClass = 'equalis-voice';
          } else if (speaker.toLowerCase() === 'disparia') {
              voiceClass = 'disparia-voice';
          } else if (speaker.toLowerCase() === 'anciano') {
              voiceClass = 'old-man-voice';
          } else {
              voiceClass = 'resaltado';
          }
          textEl.innerHTML = `<span class="${voiceClass}">${speaker}: ${content}</span>`;
      } else {
          textEl.innerHTML = content;
      }
      
      nextBtn.style.display = 'inline-flex';
      void textEl.offsetWidth; 
    }
    
    function renderChallenge(data) {
        let questionContent = formatText(data.question);
        
        // Reemplaza las líneas de la ecuación con <br>
        questionContent = questionContent.replace(/\n/g, '<br>');

        textEl.innerHTML = `<p class="challenge-question fade-text">${questionContent}</p>`;
        
        choicesEl.innerHTML = ""; 
        
        data.choices.forEach(choice => {
            const btn = document.createElement("button");
            btn.textContent = choice.text;
            btn.className = 'choice-btn'; 
            btn.onclick = () => checkAnswer(data, choice.text); 
            choicesEl.appendChild(btn);
        });
    }

    function checkAnswer(data, userAnswerText) {
        Array.from(choicesEl.children).forEach(btn => btn.disabled = true);
        
        let resultText;
        let transitionData;
        
        const isCorrect = userAnswerText === data.answer;
        
        if (isCorrect) {
            score += 1; 
            resultText = `<span class="equalis-voice fade-text">${formatText(data.success)}</span>`;
            transitionData = data.transitionSuccess;
        } else {
            score -= 1; 
            resultText = `<span class="disparia-voice fade-text">${formatText(data.failure)}</span>`;
            transitionData = data.transitionFail;
        }

        textEl.innerHTML = resultText;
        choicesEl.innerHTML = ''; 
        
        // --- CORRECCIÓN CLAVE AQUÍ ---
        nextBtn.style.display = 'inline-flex';
        nextBtn.onclick = () => {
            textEl.textContent = transitionData.text; // Mostrar el texto de transición
            nextBtn.onclick = () => { // Reasignar la acción para ir a la siguiente escena
                localStorage.setItem('score', score); 
                goTo(transitionData.nextScene);
            }
        };
        // -----------------------------
    }

    function goTo(relativePath) {
        const base = window.location.href.substring(0, window.location.href.lastIndexOf('/') + 1);
        const resolved = new URL(relativePath, base).href;
        window.location.href = resolved;
    }
    
    nextBtn.addEventListener("click", () => {
      // Solo avanzar si no estamos en un desafío resuelto
      if (choicesEl.children.length === 0 && nextBtn.onclick.toString().indexOf('goTo') === -1) {
          currentLine++;
          showLine();
      }
    });
    
    window.onload = showLine;
  </script>
</body>
</html>
