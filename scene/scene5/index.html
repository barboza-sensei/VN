<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Escena 5 — La Puerta del Teatro</title>
  <link rel="stylesheet" href="../../style.css" />
  <style>
    /* ------------------------------------------------------------------ */
    /* ESTILOS DE VOZ Y GENERALES (Completos para asegurar la estética) */
    /* ------------------------------------------------------------------ */
    * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        font-family: 'Consolas', 'Courier New', monospace; 
    }
    body {
        color: #f0f0f0; 
        font-size: 1.1em;
        line-height: 1.6;
        background-color: #0c0c1a; 
        background-size: cover;
        background-position: center;
        transition: background-image 1s ease-in-out; 
        background-image: url('assets/bg/marquesina_antigua.png'); 
    }
    
    /* --- CLASES DE VOZ CORREGIDAS --- */
    .equalis-voice { color: #aaffff; text-shadow: 0 0 5px rgba(170, 255, 255, 0.4); } 
    .disparia-voice { color: #ff9999; text-shadow: 0 0 5px rgba(255, 153, 153, 0.4); } 
    /* ¡NUEVO! Color para el Anciano: Dorado/Amarillo Oscuro */
    .old-man-voice { color: #ffcc66; text-shadow: 0 0 5px rgba(255, 204, 102, 0.4); } 

    /* --- CAJA DE DIÁLOGO BASE (CUADRO DE TEXTO) --- */
    #main-dialogue-box {
        position: absolute; bottom: 5vh; left: 50%; transform: translateX(-50%);
        width: 90%; max-width: 800px; padding: 1.5em;
        background-color: rgba(15, 15, 15, 0.9); 
        border: 1px solid rgba(255, 255, 255, 0.1); 
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4), 0 0 10px rgba(170, 255, 255, 0.1); 
        border-radius: 8px; 
    }
    
    /* --- BOTONES Y OPCIONES (ESTILO SLEEK POR DEFECTO) --- */
    #choices { 
        display: flex; flex-direction: column; 
        gap: 0; /* Sin espacio entre botones por defecto */
        margin-top: 15px; 
        border-top: 1px solid rgba(255, 255, 255, 0.1); /* Separador superior por defecto */
    }
    .choice-btn {
        background: rgba(0, 0, 0, 0.4); border: none; color: #f0f0f0;
        padding: 12px 15px; font-size: 1.1em; text-align: left; transition: all 0.2s ease;
        cursor: pointer; 
        border-bottom: 1px solid rgba(255, 255, 255, 0.1); /* Separador entre botones por defecto */
    }
    .choice-btn:hover, .choice-btn:focus {
        background: rgba(40, 40, 40, 0.6); box-shadow: 0 0 0 1px #aaffff; color: #aaffff; outline: none; 
    }
    #choices .choice-btn:last-child { border-bottom: none; }
    
    /* ------------------------------------------------------------------ */
    /* ESTILOS ESPECÍFICOS PARA EL MODO ORDENAMIENTO (SOLO EN EL DESAFÍO) */
    /* ------------------------------------------------------------------ */
    #choices.ordering-mode { 
        gap: 8px; /* Espacio entre los bloques arrastrables */
        padding: 10px; border: 1px dashed rgba(255, 255, 255, 0.2); /* Borde punteado para D&D */
        border-top: none; /* Anular el separador superior en modo desafío */
    }
    .choice-btn.ordering {
        background: rgba(40, 40, 40, 0.7); 
        border: 1px solid #aaffff; /* Borde visible para arrastre */
        border-bottom: 1px solid #aaffff; /* Borde también para el último elemento */
        cursor: grab;
        position: relative;
    }
    .choice-btn.ordering:before {
        content: '☰'; 
        margin-right: 10px;
        color: #aaffff;
        font-size: 1.2em;
        vertical-align: middle;
    }
    .choice-btn.ordering:active {
        cursor: grabbing;
        box-shadow: 0 0 10px rgba(170, 255, 255, 0.8);
    }
    
    .final-check-btn {
        margin-top: 15px;
        padding: 12px 20px;
        background: #007777;
        color: white;
        border: none;
        cursor: pointer;
        transition: background 0.3s;
        border-radius: 4px;
        font-weight: bold;
    }
    .final-check-btn:hover {
        background: #00aaaa;
    }
    /* ... (Otros estilos) ... */
  </style>
</head>

<body>
  <div class="dialogue-box" id="main-dialogue-box">
    <p id="text"></p>
    
    <div id="choices"></div>
    <button id="nextBtn" title="Continuar">➤</button> 
  </div>

  <script>
    let score = parseInt(localStorage.getItem('score') || 0);

    const IMG_GENERAL = 'assets/bg/marquesina_antigua.png';
    const IMG_DESAFIO = 'assets/bg/puerta_ecuacion.png';

    function formatText(content) {
        return content.replace(/\*\*(.*?)\*\*/g, '<span class="resaltado">$1</span>');
    }
    
    function changeBackground(imageUrl) {
        document.body.style.backgroundImage = `url('${imageUrl}')`;
    }

    // --- DATA DE LA ESCENA 5 (Desafío de Ordenamiento) ---
    const scene5 = {
      id: 5,
      title: "La Puerta del Teatro",
      text: [
        // LÍNEA DE CONTINUIDAD
        { type: 'narrative', content: "El sendero se curva una última vez y te deja frente a una imponente estructura: un viejo teatro abandonado. Su marquesina antigua titila descontroladamente."}, // i=0
        { type: 'narrative', content: "En el cartel, letras de neón cambian de orden sin parar, creando una sensación de **secuencia rota**."}, // i=1 (IMG_GENERAL)
        { type: 'voice', speaker: 'Equalis', content: "Cada paso cuenta, pero solo si los das en el **orden** correcto. El proceso es la única llave."}, // i=2
        { type: 'voice', speaker: 'Disparia', content: "La voz invisible de Disparia te llega como un eco burlón: '¿Por qué seguir el orden cuando la locura es más divertida?'"}, // i=3 -> Corregido tipo a voice
        { type: 'narrative', content: "En la puerta, una ecuación fragmentada ha sido grabada. Debes resolverla paso a paso para abrirla: (3x − 2)/4 + 5 = 8."}, // i=4 (IMG_DESAFIO)
        
        { type: 'challenge', 
          question: "Ordená los pasos de forma correcta para despejar 'x' y abrir la puerta. (Recordá invertir el orden de las operaciones: de afuera hacia adentro).", 
          steps: [
            { text: "Restar 5 en ambos lados", index: 0 }, 
            { text: "Multiplicar por 4", index: 1 }, 
            { text: "Sumar 2", index: 2 }, 
            { text: "Dividir por 3", index: 3 }  
          ],
          correctOrder: [0, 1, 2, 3], 
          answer: "x = 6", 
          success: "Equalis: El proceso ha sido respetado. El ciclo está completo. (+1 Lógica).", 
          failure: "Disparia: Un aplauso lejano resuena desde el escenario vacío. ¡El show del caos debe continuar! (-1 Lógica).", 
          transitionSuccess: { text: "La puerta se abre sola y el aire del interior huele a madera húmeda y números escritos con tiza. La luz es tenue.", nextScene: "../scene6/index.html" },
          transitionFail: { text: "Las luces de la marquesina se apagan y la puerta se sella con un ruido metálico. Buscás desesperadamente la siguiente salida.", nextScene: "../scene6/index.html" }
        }
      ]
    };

    const textEl = document.getElementById("text");
    const choicesEl = document.getElementById("choices");
    const nextBtn = document.getElementById("nextBtn");
    
    let currentLine = 0; 
    const sceneData = scene5.text; 

    function showLine() {
      if (currentLine >= sceneData.length) return;

      if (currentLine === 1) { 
        changeBackground(IMG_GENERAL);
      } else if (currentLine === 4) { 
        changeBackground(IMG_DESAFIO);
      }
      
      const lineData = sceneData[currentLine];
      textEl.className = 'fade-text'; 

      if (lineData.type === 'challenge') {
          renderOrderingChallenge(lineData);
          nextBtn.style.display = 'none'; 
          return; 
      }
      
      let content = formatText(lineData.content);
      let speaker = lineData.speaker;

      if (speaker) {
          let voiceClass;
          if (speaker.toLowerCase() === 'equalis') {
              voiceClass = 'equalis-voice';
          } else if (speaker.toLowerCase() === 'disparia') {
              voiceClass = 'disparia-voice';
          } else if (speaker.toLowerCase() === 'anciano') { // Usar esta lógica si el Anciano aparece.
              voiceClass = 'old-man-voice';
          } else {
              voiceClass = 'resaltado';
          }
          textEl.innerHTML = `<span class="${voiceClass}">${speaker}: ${content}</span>`;
      } else {
          textEl.innerHTML = content;
      }
      
      nextBtn.style.display = 'inline-flex';
      void textEl.offsetWidth; 
    }

    // --- FUNCIÓN ESPECÍFICA PARA EL DESAFÍO DE ORDENAMIENTO ---
    function renderOrderingChallenge(data) {
        // ACTIVA el modo desafío para aplicar el estilo visual de D&D a #choices
        choicesEl.classList.add('ordering-mode'); 
        
        textEl.innerHTML = `<p class="challenge-question fade-text">${formatText(data.question)}</p>`;
        choicesEl.innerHTML = ""; 
        
        let stepsToRender = [...data.steps];
        // Método simple de Fisher-Yates (Shuffle)
        for (let i = stepsToRender.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [stepsToRender[i], stepsToRender[j]] = [stepsToRender[j], stepsToRender[i]];
        }

        stepsToRender.forEach(step => {
            const btn = document.createElement("button");
            btn.textContent = step.text;
            btn.className = 'choice-btn ordering'; 
            btn.setAttribute('data-index', step.index); 
            btn.setAttribute('draggable', true);
            choicesEl.appendChild(btn);
        });

        // 2. Implementar Drag and Drop (simplificado)
        let dragSrcEl = null;

        function handleDragStart(e) {
            this.style.opacity = '0.4';
            dragSrcEl = this;
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.innerHTML);
        }

        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault(); 
            }
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        function handleDragEnter(e) {
            this.classList.add('over');
        }

        function handleDragLeave(e) {
            this.classList.remove('over'); 
        }

        function handleDrop(e) {
            e.stopPropagation(); 
            
            if (dragSrcEl !== this) {
                const targetParent = this.parentNode;
                const sourceElement = dragSrcEl;
                const targetElement = this;

                const tempNode = document.createElement('div');
                targetParent.insertBefore(tempNode, targetElement);
                targetParent.insertBefore(targetElement, sourceElement);
                targetParent.insertBefore(sourceElement, tempNode);
                targetParent.removeChild(tempNode);
            }
            return false;
        }

        function handleDragEnd(e) {
            this.style.opacity = '1';
            Array.from(choicesEl.children).forEach(item => item.classList.remove('over'));
        }

        Array.from(choicesEl.children).forEach(item => {
            if (item.classList.contains('ordering')) {
                item.addEventListener('dragstart', handleDragStart, false);
                item.addEventListener('dragenter', handleDragEnter, false);
                item.addEventListener('dragover', handleDragOver, false);
                item.addEventListener('dragleave', handleDragLeave, false);
                item.addEventListener('drop', handleDrop, false);
                item.addEventListener('dragend', handleDragEnd, false);
            }
        });
        
        // 3. Botón de Verificación
        const checkBtn = document.createElement("button");
        checkBtn.textContent = "VERIFICAR ORDEN";
        checkBtn.className = 'final-check-btn';
        checkBtn.onclick = () => checkOrdering(data);
        choicesEl.appendChild(checkBtn);
    }
    
    function checkOrdering(data) {
        // DESACTIVA el modo desafío para limpiar la estética
        choicesEl.classList.remove('ordering-mode'); 
        
        const currentOrder = Array.from(choicesEl.children)
            .filter(btn => btn.hasAttribute('data-index'))
            .map(btn => parseInt(btn.getAttribute('data-index')));
            
        const isCorrect = currentOrder.every((value, index) => value === data.correctOrder[index]);

        Array.from(choicesEl.children).forEach(btn => {
            btn.disabled = true;
            btn.setAttribute('draggable', false);
        });
        
        let resultText;
        let transitionData;
        
        if (isCorrect) {
            score += 1; 
            resultText = `<span class="equalis-voice fade-text">${formatText(data.success)}</span>`;
            transitionData = data.transitionSuccess;
        } else {
            score -= 1; 
            resultText = `<span class="disparia-voice fade-text">${formatText(data.failure)}</span>`;
            transitionData = data.transitionFail;
        }

        textEl.innerHTML = resultText;
        choicesEl.innerHTML = ''; 
        
        nextBtn.style.display = 'inline-flex';
        nextBtn.onclick = () => {
            textEl.textContent = transitionData.text; 
            nextBtn.onclick = () => {
                localStorage.setItem('score', score); 
                goTo(transitionData.nextScene);
            }
        };
    }

    function checkAnswer() { /* No usada en esta escena */ }

    function goTo(relativePath) {
        const base = window.location.href.substring(0, window.location.href.lastIndexOf('/') + 1);
        const resolved = new URL(relativePath, base).href;
        window.location.href = resolved;
    }
    
    nextBtn.addEventListener("click", () => {
      currentLine++;
      showLine();
    });
    
    window.onload = showLine;
  </script>
</body>
  </html>
  
