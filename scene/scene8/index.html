<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Escena 8 ‚Äî El Eco del T√∫nel</title>
  <link rel="stylesheet" href="../../style.css" />
  <style>
    /* -------------------------------------------------------------------- */
    /* 1. ESTILOS DE ATM√ìSFERA */
    /* -------------------------------------------------------------------- */
    body {
        /* IMAGEN INICIAL (T√∫nel Ladrillo) */
        background-image: url('assets/bg/tunel_ladrillo.png'); 
        background-color: #0c0c1a;
        background-size: cover;
        background-position: center;
        transition: background-image 1s ease-in-out; 
    }
    
    .resaltado {
        font-weight: bold;
        color: #f0f0f0; 
        text-shadow: 0 0 5px rgba(255, 255, 255, 0.4);
    }
    
    /* -------------------------------------------------------------------- */
    /* 2. ESTILOS DE DI√ÅLOGO Y BOTONES (Adaptados del sistema general) */
    /* -------------------------------------------------------------------- */
    #main-dialogue-box {
        position: absolute; bottom: 5vh; left: 50%; transform: translateX(-50%);
        width: 90%; max-width: 800px; padding: 1.5em;
        background-color: rgba(15, 15, 15, 0.3); 
        border: 1px solid rgba(255, 255, 255, 0.1); 
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
    }
    #choices { display: flex; flex-direction: column; gap: 0; margin-top: 15px; }
    .choice-btn {
        background: rgba(0, 0, 0, 0.4); border: none; border-radius: 0; color: #f0f0f0;
        padding: 12px 15px; font-size: 1.1em; text-align: left; transition: all 0.2s ease;
        cursor: pointer; border-bottom: 1px solid rgba(255, 255, 255, 0.1); 
    }
    .choice-btn:hover, .choice-btn:focus {
        background: rgba(40, 40, 40, 0.6); box-shadow: 0 0 0 1px #aaffff; color: #aaffff; outline: none; 
    }
    #choices .choice-btn:last-child { border-bottom: none; }
    #nextBtn::after { content: none !important; visibility: hidden; }
    #nextBtn { text-indent: 0; overflow: visible; }

    /* COLORES DE VOZ (Asumidos) */
    .equalis-voice { color: #aaffff; text-shadow: 0 0 5px rgba(170, 255, 255, 0.4); } 
    .disparia-voice { color: #ff9999; text-shadow: 0 0 5px rgba(255, 153, 153, 0.4); } 
    .old-man-voice { color: #ffcc66; text-shadow: 0 0 5px rgba(255, 204, 102, 0.4); } 
  </style>
</head>

<body>
  <div class="dialogue-box" id="main-dialogue-box">
    <p id="text"></p>
    
    <div id="choices"></div>
    <button id="nextBtn" title="Continuar">‚û§</button> 
  </div>

  <script>
    // --------------------------------------------------
    // 1. INICIALIZACI√ìN Y CONFIGURACI√ìN
    // --------------------------------------------------
    let score = parseInt(localStorage.getItem('score') || 0);

    const IMG_GENERAL = 'assets/bg/tunel_ladrillo.png';
    const IMG_DESAFIO = 'assets/bg/ecuacion_rebotando.png'; // Usado para mostrar la ecuaci√≥n

    const textEl = document.getElementById("text");
    const choicesEl = document.getElementById("choices");
    const nextBtn = document.getElementById("nextBtn");
    
    let currentLine = 0; 

    // --- DATA DE LA ESCENA 8 ---
    const scene8 = {
      id: 8,
      title: "El eco del t√∫nel",
      text: [
        { type: 'narrative', content: "Entras a un pasaje de ladrillo. El ambiente g√©lido y h√∫medo absorbe el sonido, pero tu presencia rompe la calma."}, 
        { type: 'voice', speaker: 'Equalis', content: "El eco de este lugar distorsiona el **equilibrio** en una **desigualdad**."}, 
        { type: 'voice', speaker: 'Disparia', content: "¬°Interesante! ¬øPor qu√© complicarse? La direcci√≥n del camino es clara. **Solo tienes que invertir su polaridad y mantener el rumbo**."}, 
        { type: 'narrative', content: "La humedad del t√∫nel se condensa sobre el ladrillo, formando un **goteo negro y aceitoso que revela una incisi√≥n luminosa en la pared**: **-3x < 6**"}, 
        { type: 'voice', speaker: 'Equalis', content: "Esa **oscura atadura** que sujeta la inc√≥gnita tiene **polaridad negativa**. ¬øCu√°l es la ley que rige la direcci√≥n de la desigualdad al liberarla?"}, 
        { type: 'challenge', 
          question: "La **atadura** es **-3**. Al forzar su liberaci√≥n, ¬øqu√© efecto tiene su **polaridad** sobre la direcci√≥n del camino desigual?", 
          success: "Equalis: La ley de la desigualdad ha sido honrada. La direcci√≥n se invierte ante la polaridad opuesta. (+1 L√≥gica).", 
          failure: "Disparia: ¬°Un suspiro! Esos peque√±os errores son los que hacen la vida interesante. El Caos agradece la confusi√≥n. (-1 L√≥gica).",
          transitionSuccess: { text: "El eco se apaga. Una puerta familiar aparece adelante, brillante y s√≥lida.", nextScene: "../scene9/index.html" },
          transitionFail: { text: "El eco te responde con tu propio nombre, repetido mil veces, y el t√∫nel se alarga.", nextScene: "../scene9/index.html" },
          choices: [
              { text: "La polaridad negativa del elemento no afecta la direcci√≥n, solo el valor de la inc√≥gnita.", isCorrect: false }, 
              { text: "La direcci√≥n del camino desigual debe invertirse (cambiar de < a >) cuando se aplica la operaci√≥n de un elemento de polaridad negativa.", isCorrect: true }, 
              { text: "La atadura negativa convierte la desigualdad estricta (<) en una no estricta (‚â§).", isCorrect: false }
          ]
        }
      ]
    };
    
    const sceneData = scene8.text; 

    // --------------------------------------------------
    // 2. FUNCIONES DE UTILIDAD
    // --------------------------------------------------
    function formatText(content) {
        return content.replace(/\*\*(.*?)\*\*/g, '<span class="resaltado">$1</span>');
    }
    
    function changeBackground(imageUrl) {
        document.body.style.backgroundImage = `url('${imageUrl}')`;
    }

    // --------------------------------------------------
    // 3. FLUJO PRINCIPAL DE LA ESCENA
    // --------------------------------------------------
    function showLine() {
      if (currentLine >= sceneData.length) return;

      // L√≥gica de cambio de fondo seg√∫n el di√°logo
      if (currentLine === 0) { 
        changeBackground(IMG_GENERAL);
      } else if (currentLine === 3) { 
        changeBackground(IMG_DESAFIO);
      }
      
      const lineData = sceneData[currentLine];
      textEl.className = 'fade-text'; 

      if (lineData.type === 'challenge') {
          renderChallenge(lineData);
          nextBtn.style.display = 'none'; 
          return; 
      }
      
      let content = formatText(lineData.content);
      let speaker = lineData.speaker;
      
      if (speaker) {
          let voiceClass;
          if (speaker.toLowerCase() === 'equalis') {
              voiceClass = 'equalis-voice';
          } else if (speaker.toLowerCase() === 'disparia') {
              voiceClass = 'disparia-voice';
          } else if (speaker.toLowerCase() === 'anciano') {
              voiceClass = 'old-man-voice';
          } else {
              voiceClass = 'resaltado';
          }
          textEl.innerHTML = `<span class="${voiceClass}">${speaker}: ${content}</span>`;
      } else {
          textEl.innerHTML = content;
      }
      
      nextBtn.style.display = 'inline-flex';
      void textEl.offsetWidth; 
    }
    
    function renderChallenge(data) {
        let questionContent = formatText(data.question);
        
        // Reemplaza los saltos de l√≠nea con <br>
        questionContent = questionContent.replace(/\n/g, '<br>');

        textEl.innerHTML = `<p class="challenge-question fade-text">${questionContent}</p>`;
        
        choicesEl.innerHTML = ""; 
        
        data.choices.forEach(choice => {
            const btn = document.createElement("button");
            btn.textContent = choice.text;
            btn.className = 'choice-btn'; 
            // Pasamos el texto de la opci√≥n para identificarla m√°s tarde
            btn.onclick = () => checkAnswer(data, choice.text); 
            choicesEl.appendChild(btn);
        });
    }

    // --------------------------------------------------
    // 4. FUNCI√ìN DE RESPUESTA Y VALIDACI√ìN (CORREGIDA)
    // --------------------------------------------------
    function checkAnswer(data, userAnswerText) {
        Array.from(choicesEl.children).forEach(btn => btn.disabled = true);
        
        let resultText;
        let transitionData;
        
        // üö® CORRECCI√ìN: Buscamos en el array de opciones cu√°l fue seleccionada 
        // y verificamos su propiedad isCorrect.
        const chosenOption = data.choices.find(choice => choice.text === userAnswerText);
        const isCorrect = chosenOption ? chosenOption.isCorrect : false;

        // L√≥gica de puntaje y feedback
        if (isCorrect) {
            score += 1; 
            resultText = `<span class="equalis-voice fade-text">${formatText(data.success)}</span>`;
            transitionData = data.transitionSuccess;
        } else {
            score -= 1; 
            resultText = `<span class="disparia-voice fade-text">${formatText(data.failure)}</span>`;
            transitionData = data.transitionFail;
        }

        textEl.innerHTML = resultText;
        choicesEl.innerHTML = ''; 
        
        // Configuraci√≥n del bot√≥n para la transici√≥n
        nextBtn.style.display = 'inline-flex';
        nextBtn.onclick = () => {
            textEl.textContent = transitionData.text; 
            // Segundo click para guardar score y navegar
            nextBtn.onclick = () => {
                localStorage.setItem('score', score); 
                goTo(transitionData.nextScene);
            }
        };
    }

    function goTo(relativePath) {
        const base = window.location.href.substring(0, window.location.href.lastIndexOf('/') + 1);
        const resolved = new URL(relativePath, base).href;
        window.location.href = resolved;
    }
    
    nextBtn.addEventListener("click", () => {
      if (choicesEl.children.length === 0) {
          currentLine++;
          showLine();
      }
    });
    
    window.onload = showLine;
  </script>
</body>
</html>
